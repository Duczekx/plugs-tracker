generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Variant {
  ZINC
  ORANGE
}

enum ValveType {
  NONE
  SMALL
  LARGE
}

enum Model {
  FL_640
  FL_540
  FL_470
  FL_400
  FL_340
  FL_260
}

enum ShipmentStatus {
  RESERVED
  READY
  SENT
}

enum BomConfiguration {
  STANDARD
  STANDARD_6_2
  SCHWENKBOCK
  SCHWENKBOCK_6_2
}

enum BomType {
  STANDARD
  ADDON_6_2
  SCHWENKBOCK_3000
  SCHWENKBOCK_2000
}

enum PartMovementReason {
  READY_SHIPMENT
  ROLLBACK_SHIPMENT
  MANUAL_ADJUST
}

model InventoryItem {
  id            Int      @id @default(autoincrement())
  model         Model    @default(FL_540)
  serialNumber  Int      @default(0)
  variant       Variant
  isSchwenkbock Boolean  @default(false)
  quantity      Int      @default(0)
  isManual      Boolean  @default(false)
  updatedAt     DateTime @updatedAt

  @@unique([model, serialNumber, variant, isSchwenkbock])
}

model Shipment {
  id          Int            @id @default(autoincrement())
  companyName String
  firstName   String
  lastName    String
  street      String
  postalCode  String
  city        String
  country     String
  notes       String?
  createdAt   DateTime       @default(now())
  status      ShipmentStatus @default(READY)

  items         ShipmentItem[]
  extras        ShipmentExtraItem[]
  partMovements PartMovement[]
}

model ShipmentItem {
  id            Int              @id @default(autoincrement())
  shipmentId    Int
  shipment      Shipment         @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  model         Model            @default(FL_540)
  serialNumber  Int              @default(0)
  variant       Variant
  isSchwenkbock Boolean          @default(false)
  configuration BomConfiguration @default(STANDARD)
  quantity      Int
  buildNumber   String
  buildDate     DateTime
  bucketHolder  Boolean          @default(false)
  valveType     ValveType        @default(NONE)
  extraParts    String?

  @@index([shipmentId])
}

model ShipmentExtraItem {
  id         Int      @id @default(autoincrement())
  shipmentId Int
  shipment   Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  partId     Int?
  part       Part?    @relation(fields: [partId], references: [id], onDelete: SetNull)
  name       String
  quantity   Int
  note       String?
  createdAt  DateTime @default(now())

  @@index([shipmentId])
  @@index([partId])
}

model Part {
  id                Int     @id @default(autoincrement())
  name              String  @unique
  unit              String  @default("szt")
  stock             Int     @default(0)
  shopUrl           String?
  shopName          String?
  isArchived        Boolean @default(false)
  warningThreshold  Int?
  criticalThreshold Int?

  bomItems           BomItem[]
  shipmentExtraItems ShipmentExtraItem[]
  movements          PartMovement[]

  @@index([name])
  @@index([stock])
}

model Bom {
  id            Int              @id @default(autoincrement())
  modelName     String
  bomType       BomType

  items BomItem[]

  @@unique([modelName, bomType])
}

model BomItem {
  id         Int  @id @default(autoincrement())
  bomId      Int
  bom        Bom  @relation(fields: [bomId], references: [id], onDelete: Cascade)
  partId     Int
  part       Part @relation(fields: [partId], references: [id], onDelete: Cascade)
  qtyPerPlow Int

  @@unique([bomId, partId])
}

model PartMovement {
  id         Int                @id @default(autoincrement())
  partId     Int
  part       Part               @relation(fields: [partId], references: [id], onDelete: Cascade)
  delta      Int
  reason     PartMovementReason
  shipmentId Int?
  shipment   Shipment?          @relation(fields: [shipmentId], references: [id], onDelete: SetNull)
  note       String?
  actor      String?
  createdAt  DateTime           @default(now())

  @@index([createdAt])
  @@index([partId])
  @@index([shipmentId])
  @@index([reason])
}

model ActivityLog {
  id         Int      @id @default(autoincrement())
  createdAt  DateTime @default(now())
  type       String
  entityType String
  entityId   String
  summary    String
  meta       Json?

  @@index([createdAt])
  @@index([type])
}
